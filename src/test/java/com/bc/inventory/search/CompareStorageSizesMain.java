package com.bc.inventory.search;

import com.bc.geometry.s2.S2WKTReader;
import com.bc.inventory.utils.S2Integer;
import com.google.common.geometry.S2CellId;
import com.google.common.geometry.S2CellUnion;
import com.google.common.geometry.S2Polygon;
import com.google.common.geometry.S2RegionCoverer;
import me.lemire.integercompression.differential.IntegratedIntCompressor;
import org.roaringbitmap.RoaringBitmap;

import java.io.IOException;
import java.util.ArrayList;

public class CompareStorageSizesMain {

    static String MODIS_WKT = "POLYGON((-96.5327666830256 87.1546434730307,103.743686712102 71.3437478705495,59.2615258995161 65.0182420500955,0.362928123129433 73.3758030120494,-96.5327666830256 87.1546434730307))";
    static String MERIS_RR_WKT = "POLYGON ((41.43260955810547 75.59603881835938, 46.37111282348633 75.20641326904297, 51.03156661987305 74.71737670898438, 55.38518142700195 74.13809204101562, 59.42019271850586 73.47802734375, 63.137386322021484 72.74620056152344, 66.5494384765625 71.9515380859375, 69.67420196533203 71.1019287109375, 72.532958984375 70.20442199707031, 69.58192443847656 69.11993408203125, 66.91184997558594 67.99058532714844, 64.49073791503906 66.8228759765625, 62.28947448730469 65.62226867675781, 60.28261947631836 64.39327239990234, 58.446510314941406 63.13984680175781, 56.76107406616211 61.865196228027344, 55.208797454833984 60.57204818725586, 53.774784088134766 59.26264953613281, 52.44538116455078 57.93901062011719, 51.20907974243164 56.6027946472168, 50.05585479736328 55.255409240722656, 48.977195739746094 53.89805221557617, 47.96519470214844 52.53179931640625, 47.0131721496582 51.157569885253906, 46.115257263183594 49.77615737915039, 45.266414642333984 48.38822555541992, 44.461910247802734 46.99441146850586, 43.69770812988281 45.59524154663086, 42.970211029052734 44.191192626953125, 42.276329040527344 42.78266906738281, 41.61308670043945 41.37006378173828, 40.977943420410156 39.95370101928711, 40.36859130859375 38.53389358520508, 39.78306198120117 37.11089324951172, 39.219390869140625 35.684959411621094, 38.675926208496094 34.256317138671875, 38.151123046875 32.825164794921875, 37.6436653137207 31.391681671142578, 37.152225494384766 29.956045150756836, 36.67565155029297 28.518415451049805, 36.212913513183594 27.07893943786621, 35.76306915283203 25.637737274169922, 35.325199127197266 24.194950103759766, 34.89847946166992 22.750694274902344, 34.482181549072266 21.305076599121094, 34.075618743896484 19.858192443847656, 33.678131103515625 18.4101505279541, 33.28911209106445 16.961042404174805, 32.90802001953125 15.510952949523926, 32.53434753417969 14.05996322631836, 32.16759490966797 12.60815715789795, 31.80730438232422 11.155607223510742, 31.453060150146484 9.702387809753418, 31.10447120666504 8.248566627502441, 30.761144638061523 6.794210910797119, 30.422725677490234 5.339385032653809, 30.088878631591797 3.8841519355773926, 29.75929069519043 2.42856764793396, 29.433639526367188 0.9726920127868652, 29.11163902282715 -0.4834202527999878, 28.792999267578125 -1.9397159814834595, 28.477468490600586 -3.396144151687622, 28.16476058959961 -4.852655410766602, 27.85463523864746 -6.309200286865234, 27.54683494567871 -7.765735149383545, 27.24112892150879 -9.222210884094238, 26.937265396118164 -10.678589820861816, 26.635013580322266 -12.134824752807617, 26.334135055541992 -13.590879440307617, 26.03440284729004 -15.046710968017578, 25.735580444335938 -16.502288818359375, 25.437427520751953 -17.957571029663086, 25.139711380004883 -19.412521362304688, 24.84218406677246 -20.867115020751953, 24.54459571838379 -22.32131004333496, 24.246694564819336 -23.77507972717285, 23.948205947875977 -25.2283992767334, 23.648862838745117 -26.681236267089844, 23.34836769104004 -28.133562088012695, 23.046415328979492 -29.585350036621094, 22.74268341064453 -31.03658103942871, 22.43682098388672 -32.487220764160156, 22.128469467163086 -33.937259674072266, 21.81722640991211 -35.38666915893555, 21.502660751342773 -36.83542251586914, 21.18429946899414 -38.28350830078125, 20.86163330078125 -39.73089599609375, 20.53411102294922 -41.17755889892578, 20.201107025146484 -42.623497009277344, 19.861919403076172 -44.06867218017578, 19.515790939331055 -45.5130615234375, 19.161869049072266 -46.95665740966797, 18.799179077148438 -48.399410247802734, 18.426591873168945 -49.84131622314453, 18.042882919311523 -51.282325744628906, 17.646615982055664 -52.722412109375, 17.23613739013672 -54.16154479980469, 16.809471130371094 -55.59966278076172, 16.364410400390625 -57.03671646118164, 15.966340065002441 -58.267581939697266, 13.53857707977295 -58.02053451538086, 11.147062301635742 -57.727874755859375, 8.796685218811035 -57.390838623046875, 6.491703987121582 -57.01079177856445, 4.235889434814453 -56.589073181152344, 2.032036542892456 -56.12738037109375, -0.1175561770796776 -55.62731170654297, -2.211195945739746 -55.090538024902344, -1.2928783893585205 -53.93122100830078, -0.2826132774353027 -52.570457458496094, 0.6680009961128235 -51.20165252685547, 1.5646255016326904 -49.82556915283203, 2.4125804901123047 -48.44291687011719, 3.216391086578369 -47.054298400878906, 3.9800686836242676 -45.66023635864258, 4.70706844329834 -44.26118087768555, 5.400692939758301 -42.85755920410156, 6.063774108886719 -41.449745178222656, 6.698849201202393 -40.038063049316406, 7.308116436004639 -38.622802734375, 7.893718242645264 -37.2042350769043, 8.457498550415039 -35.78260040283203, 9.001132011413574 -34.35812759399414, 9.52607536315918 -32.930999755859375, 10.033772468566895 -31.50140953063965, 10.525473594665527 -30.069522857666016, 11.002324104309082 -28.635496139526367, 11.465327262878418 -27.199459075927734, 11.91549015045166 -25.761558532714844, 12.353693962097168 -24.321910858154297, 12.780750274658203 -22.880634307861328, 13.197372436523438 -21.437829971313477, 13.604288101196289 -19.993606567382812, 14.002140998840332 -18.54805564880371, 14.391520500183105 -17.101272583007812, 14.772960662841797 -15.653332710266113, 15.147000312805176 -14.204326629638672, 15.514122009277344 -12.754329681396484, 15.87477970123291 -11.303417205810547, 16.2293758392334 -9.851655960083008, 16.57832908630371 -8.399118423461914, 16.92201805114746 -6.945869445800781, 17.260799407958984 -5.491971969604492, 17.594993591308594 -4.037485122680664, 17.924938201904297 -2.582470417022705, 18.250940322875977 -1.1269840002059937, 18.573291778564453 0.3289200067520142, 18.892261505126953 1.7851879596710205, 19.20813751220703 3.2417690753936768, 19.52117919921875 4.698611259460449, 19.831640243530273 6.155667781829834, 20.139760971069336 7.612892150878906, 20.44579315185547 9.07023811340332, 20.749977111816406 10.527661323547363, 21.052547454833984 11.985119819641113, 21.353731155395508 13.442571640014648, 21.65377426147461 14.89997673034668, 21.95290184020996 16.357295989990234, 22.251352310180664 17.81449317932129, 22.549365997314453 19.27153205871582, 22.84718894958496 20.728376388549805, 23.14506721496582 22.18498992919922, 23.443256378173828 23.641345977783203, 23.742029190063477 25.0974063873291, 24.041658401489258 26.553146362304688, 24.342439651489258 28.008533477783203, 24.644670486450195 29.463539123535156, 24.948688507080078 30.918136596679688, 25.254831314086914 32.37229919433594, 25.563467025756836 33.82600021362305, 25.874996185302734 35.27921676635742, 26.189861297607422 36.73191452026367, 26.50851821899414 38.18408203125, 26.83148193359375 39.63568878173828, 27.159313201904297 41.08671188354492, 27.49265480041504 42.5371208190918, 27.832178115844727 43.986900329589844, 28.17865562438965 45.43601608276367, 28.53294563293457 46.88445281982422, 28.896060943603516 48.3321647644043, 29.269071578979492 49.779136657714844, 29.65324592590332 51.225318908691406, 30.05002212524414 52.67068862915039, 30.461116790771484 54.11518859863281, 30.888427734375 55.55877685546875, 31.334213256835938 57.00139617919922, 31.801132202148438 58.44297409057617, 32.29243469238281 59.883426666259766, 32.811832427978516 61.322662353515625, 33.36388397216797 62.76055145263672, 33.954132080078125 64.19695281982422, 34.589595794677734 65.63167572021484, 35.278663635253906 67.06448364257812, 36.03207015991211 68.49510192871094, 36.86355972290039 69.9231185913086, 37.79135513305664 71.34803009033203, 38.83884048461914 72.7691650390625, 40.03792190551758 74.18559265136719, 41.43260955810547 75.59603881835938))";
    static String MERIS_FR_WKT = "POLYGON ((138.30107223393145 23.253934860229492, 139.69672216211544 23.004155158996582, 141.0871113719828 22.742127418518066, 142.47210473174582 22.46805191040039, 143.85153283027245 22.182132720947266, 145.22527751450147 21.88454580307007, 146.5932316429436 21.575547218322754, 147.95529956489526 21.25535821914673, 149.3113853472333 20.924209594726562, 148.90677514547156 19.471482753753662, 148.5111086813712 18.017614364624023, 148.1238210667643 16.562698364257812, 147.7443542925414 15.106818199157715, 147.3722356003905 13.650056838989258, 147.00693451634874 12.19249439239502, 146.64802566844892 10.734206438064575, 146.29507411147148 9.275266647338867, 145.94770382666735 7.815741062164307, 145.60552960912062 6.35569953918457, 145.26818418338098 4.895204067230225, 144.93534951692368 3.434317111968994, 144.6067002364003 1.9730979800224304, 144.2819278016391 0.5116035044193268, 143.96073866229537 -0.9501090198755264, 143.6428542245567 -2.4119889736175537, 143.3280025360792 -3.8739837408065796, 143.0159298555793 -5.336042881011963, 142.89181549009788 -5.920874118804932, 141.60611266155385 -5.646368622779846, 140.3216185219905 -5.369025468826294, 139.0382877304701 -5.0889856815338135, 137.75607244411077 -4.806392192840576, 136.47492919975033 -4.521381258964539, 135.19477883408243 -4.234104156494141, 133.91556977368307 -3.9447067975997925, 132.63726776421777 -3.653333902359009, 132.7694170171549 -3.069119095802307, 133.0970075736246 -1.6082469522953033, 133.42082297712963 -0.1469369977712631, 133.74114945859998 1.3147567510604858, 134.05825703359403 2.7767820358276367, 134.37244447208613 4.239086627960205, 134.68393010973523 5.701622009277344, 134.99298429598483 7.164338946342468, 135.29985767136506 8.627191543579102, 135.6048016173339 10.090135335922241, 135.90803344674518 11.553125381469727, 136.2097944475156 13.016120672225952, 136.51032318975075 14.47907829284668, 136.80986418998802 15.94196081161499, 137.10864276874358 17.40472984313965, 137.4069174537786 18.867345333099365, 137.70490208249853 20.329774856567383, 138.0028691360768 21.791983127593994, 138.30107223393145 23.253934860229492))";
    static String SENTINEL2_WKT = "POLYGON ((15.341495557213907 46.95319964711323, 16.01892534603299 46.94917521101262, 16.442508097938042 46.94462144092325, 16.416656101599635 45.95676985860039, 15.66898849123909 45.96357729838823, 14.999741870046797 45.96555114804152, 14.999741761783032 45.98884657014768, 15.281497356254798 46.78980418344354, 15.33979133590563 46.953204987326686, 15.341495557213907 46.95319964711323))";

    public static void main(String[] args) throws IOException {
        test("modis", MODIS_WKT);
        test("meris RR", MERIS_RR_WKT);
        test("meris FR", MERIS_FR_WKT);
        test("sentinel 2", SENTINEL2_WKT);
    }

    static void test(String sensor, String wkt) throws IOException {
        S2WKTReader wktReader = new S2WKTReader();
        S2Polygon s2Polygon = (S2Polygon) wktReader.read(wkt);
        test(sensor, s2Polygon);
    }

    static void test(String sensor, S2Polygon s2Polygon) throws IOException {
        System.out.println("sensor     = " + sensor);
        double area = s2Polygon.getArea();
        System.out.printf("area       = %.4f%%%n", (area / (4 * Math.PI))*100);
        int lastCovLength = -1;
        System.out.println();
        System.out.println("level || extCov/area |   cov  | de.cov |   rb    |  PFOR  || intCov/area |   cov  | de.cov |   rb    |  PFOR  |");
        System.out.println("------||-------------|--------|--------|---------|--------||-------------|--------|--------|---------|--------|");

        for (int maxLevel = 0; maxLevel < 20; maxLevel++) {
            S2RegionCoverer coverer = new S2RegionCoverer();
            coverer.setMinLevel(0);
            coverer.setMaxLevel(maxLevel);
            coverer.setMaxCells(500);

            CoveragStat eStat = CoveragStat.create(coverer.getCovering(s2Polygon), maxLevel);
            double eRatio = eStat.area / area;
            if (eStat.covSize > 5 && (lastCovLength == eStat.covSize || eRatio < 1.05)) {
                break;
            }
            lastCovLength = eStat.covSize;
            if (eRatio > 1.5) {
                continue;
            }
            CoveragStat iStat = CoveragStat.create(coverer.getInteriorCovering(s2Polygon), maxLevel);

            String format = "   %2d ||  %9.4f  | %6d | %6d | %7d | %6d ||  %9.7f  | %6d | %6d | %7d | %6d |";
            int eBytes = eStat.roaringBitmap.serializedSizeInBytes();
            int iBytes = iStat.roaringBitmap.serializedSizeInBytes();
            System.out.printf(format, maxLevel,
                    eRatio, eStat.covSize*4, eStat.deNormCovSize, eBytes, eStat.compressed.length*4,
                    iStat.area / area, iStat.covSize*4, iStat.deNormCovSize, iBytes, iStat.compressed.length*4
            );
            System.out.println();
        }
        System.out.println();
    }

    private static class CoveragStat {
        final double area;
        final int covSize;
        final int deNormCovSize;
        final RoaringBitmap roaringBitmap;
        final int[] compressed;

        public CoveragStat(double area, int covSize, int deNormCovSize, RoaringBitmap roaringBitmap, int[] compressed) {
            this.area = area;
            this.covSize = covSize;
            this.deNormCovSize = deNormCovSize;
            this.roaringBitmap = roaringBitmap;
            this.compressed = compressed;
        }

        public static CoveragStat create(S2CellUnion cov, int maxLevel) {
            double covArea = cov.exactArea();


            ArrayList<S2CellId> deCov = new ArrayList<>();
            cov.denormalize(maxLevel, 1, deCov);

            RoaringBitmap roaringBitmap = new RoaringBitmap();
            for (S2CellId s2CellId : deCov) {
                roaringBitmap.add(S2Integer.asIntAtLevel(s2CellId, maxLevel));
            }
            roaringBitmap.runOptimize();

            IntegratedIntCompressor iic = new IntegratedIntCompressor();
            int[] data = new int[cov.size()];
            for (int i = 0; i < cov.size(); i++) {
                 data[i] = asIntAtLevel(cov.cellId(i), maxLevel);
            }
            int[] compressed = iic.compress(data);
            //System.out.println("maxLevel = " + maxLevel+ "  compressed.length = " + compressed.length);
            //System.out.println("maxLevel = " + maxLevel+ "  roaringBitmap = " + roaringBitmap);
            return new CoveragStat(covArea, cov.size(), deCov.size(), roaringBitmap, compressed);
        }

        public static int asIntAtLevel(S2CellId s2CellId, int level) {
            return (int) (s2CellId.id() >>> (64 - 3 - (2*level)));
        }

    }
}
